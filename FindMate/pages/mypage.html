<!-- pages/mypage.html -->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <title>마이페이지 | FindMate</title>
    <style>
      .row-scroll { scroll-behavior: smooth; overflow-x: auto; scroll-snap-type: x mandatory; }
      .card { scroll-snap-align: start; min-width: 320px; }
      .wrap-anywhere { overflow-wrap: anywhere; word-break: break-word; }
    </style>
  </head>
  <body class="font-[Pretendard] bg-gray-50">
    <!-- NAV -->
    <div id="navbar">
      <a class="logo" href="{{ url_for('home') }}">
        <img
          src="{{ url_for('static', filename='images/book-open-svgrepo-com.png') }}"
          alt="icon"
          id="bookIcon"
        />
        FindMate
      </a>
      <a class="logo" href="/"
        ><img
          src="{{ url_for('static', filename='images/book-open-svgrepo-com.png') }}"
          alt="icon"
          id="bookIcon"
          class="w-6 h-6"
        />
      <nav class="nav-right">
        {% if user %}
          <a href="{{ url_for('mypage') }}" class="link">마이페이지</a>
          <a href="{{ url_for('logout') }}" class="btn btn-primary">로그아웃</a>
        {% else %}
          <a href="{{ url_for('login') }}" class="link">로그인</a>
          <a href="{{ url_for('signup') }}" class="btn btn-primary">회원가입</a>
        {% endif %}
      </nav>
    </div>

    <!-- Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="max-w-5xl mx-auto px-6 mt-4">
          {% for category, message in messages %}
            <div class="text-sm my-2 {{ 'text-red-500' if category=='error' else 'text-green-600' }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="flex flex-col min-h-[calc(100vh-64px)]">
      <main class="max-w-5xl mx-auto px-4 py-8 w-full">
        <!-- 내가 만든 스터디 -->
        <section class="mt-12 mb-24">
          <div class="flex items-center justify-between">
            <h2 class="mt-4 text-2xl font-extrabold text-gray-800">내가 만든 스터디 모임</h2>
            <div class="flex items-center gap-2">
              <button class="px-3 py-1 border rounded" onclick="scrollRow('hosted', -1)">◀</button>
              <button class="px-3 py-1 border rounded" onclick="scrollRow('hosted', 1)">▶</button>
            </div>
          </div>

          <div class="mt-4 bg-white rounded-2xl shadow-sm p-6">
            {% if hosted_studies %}
              <div id="row-hosted" class="row-scroll flex gap-6 p-2">
                {% for s in hosted_studies %}
                  {% set sid = (s.id or s._id)|string %}
                  {% set is_active = (s.active if s.active is not none else true) %}
                  {% set when = s.date or s.startText %}
                  {% set cat = s.category %}
          
                  <a href="{{ url_for('study_detail', study_id=sid) }}" class="block no-underline text-inherit">
                    <article
                      class="card flex-shrink-0 w-80 h-60 p-6 bg-white border border-gray-200 rounded-2xl shadow-sm hover:shadow-md transition hover:-translate-y-0.5 cursor-pointer"
                      role="link"
                      aria-label="{{ s.title }}"
                    >
                      <div class="h-full flex flex-col justify-between">
                        <div class="flex items-center justify-between mb-3">
                          <div class="flex items-center gap-2">
                            <span class="px-2.5 py-1 rounded-full text-xs font-semibold
                              {{ 'bg-emerald-50 text-emerald-700 border border-emerald-200' if is_active else 'bg-gray-100 text-gray-500 border border-gray-200' }}">
                              {{ '모집중' if is_active else '마감' }}
                            </span>
                            {% if cat %}
                              <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-50 text-gray-700 border border-gray-200">
                                {% if cat_map %}{{ cat_map.get(cat, cat) }}{% else %}{{ cat }}{% endif %}
                              </span>
                            {% endif %}
                          </div>
                          <span class="text-sm text-gray-500">
                            👥 {{ s.applicants_count|default(0) }}/{{ s.capacity|default('-') }}
                          </span>
                        </div>
          
                        <div class="text-center">
                          <h3 class="font-extrabold text-lg text-gray-800 mb-2 wrap-anywhere">
                            {{ s.title }}
                          </h3>
                          <p class="text-gray-600 text-sm">{{ when or '' }}</p>
                        </div>
                      </div>
                    </article>
                  </a>
                {% endfor %}
              </div>
            {% else %}
              <div class="w-full flex justify-center items-center h-48 rounded-2xl">
                <p class="text-gray-500">주최한 스터디가 없습니다.</p>
              </div>
            {% endif %}
          </div>
          
        </section>

        <!-- 내가 참여한 스터디 -->
        <section class="mb-24">
          <div class="flex items-center justify-between">
            <h2 class="mt-4 text-2xl font-extrabold text-gray-800">내가 참여한 스터디 모임</h2>
            <div class="flex items-center gap-2">
              <button class="px-3 py-1 border rounded" onclick="scrollRow('applied', -1)">◀</button>
              <button class="px-3 py-1 border rounded" onclick="scrollRow('applied', 1)">▶</button>
            </div>
          </div>

          <div class="mt-4 bg-white rounded-2xl shadow-sm p-6">
            {% if attended_studies %}
              <div id="row-applied" class="row-scroll flex gap-6 p-2">
                {% for s in attended_studies %}
                  {% set sid = s.id or s._id %}
                  {% set is_active = (s.active if s.active is not none else true) %}
                  {% set when = s.date or s.startText %}
                  {% set cat = s.category %}

                  <a href="{{ url_for('study_detail', study_id=sid) }}" class="block no-underline text-inherit">
                    <article
                      class="card flex-shrink-0 w-80 h-60 p-6 bg-white border border-gray-200 rounded-2xl shadow-sm hover:shadow-md transition hover:-translate-y-0.5 cursor-pointer"
                      role="link"
                      aria-label="{{ s.title }}"
                    >
                    <div class="h-full flex flex-col justify-between">
                      <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                          <span class="px-2.5 py-1 rounded-full text-xs font-semibold
                            {{ 'bg-emerald-50 text-emerald-700 border border-emerald-200' if is_active else 'bg-gray-100 text-gray-500 border border-gray-200' }}">
                            {{ '모집중' if is_active else '마감' }}
                          </span>
                          {% if cat %}
                            <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-50 text-gray-700 border border-gray-200">
                              {% if cat_map %}{{ cat_map.get(cat, cat) }}{% else %}{{ cat }}{% endif %}
                            </span>
                          {% endif %}
                        </div>
                        <span class="text-sm text-gray-500">
                          👥 {{ s.applicants_count|default(0) }}/{{ s.capacity|default('-') }}
                        </span>
                      </div>

                      <div class="text-center">
                        <h3 class="font-extrabold text-lg text-gray-800 mb-2 wrap-anywhere">
                          {{ s.title }}
                        </h3>
                        <p class="text-gray-600 text-sm">{{ when or '' }}</p>
                      </div>
                    </div>
                  </article>
                {% endfor %}
              </div>
            {% else %}
              <div class="w-full flex justify-center items-center h-48 rounded-2xl">
                <p class="text-gray-500">신청한 스터디가 없습니다.</p>
              </div>
            {% endif %}
          </div>
        </section>
      </main>
    </div>

    <script>
      function scrollRow(which, dir) {
        const el = document.getElementById(which === 'hosted' ? 'row-hosted' : 'row-applied');
        if (!el) return;
        const step = 360; // 카드 너비+간격
        el.scrollLeft += dir * step;
      }
    </script>
  </body>
</html>
