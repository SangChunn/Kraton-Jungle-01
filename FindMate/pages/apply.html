<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    as="style"
    crossorigin
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
  />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ì •ì  ë¦¬ì†ŒìŠ¤ëŠ” url_for ì‚¬ìš© -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <title>{{ study.title }} | FindMate</title>
</head>
<body class="font-[Pretendard] bg-gray-50">
  <!-- NAV -->
  <div id="navbar">
    <a class="logo" href="{{ url_for('home') }}"
      ><img
        src="{{ url_for('static', filename='IMG/book.png') }}"
        alt="icon"
        id="bookIcon"
      />FindMate</a
    >
    <nav class="nav-right">
      {% if user %}
        <a href="{{ url_for('mypage') }}" class="link">ë§ˆì´í˜ì´ì§€</a>
        <a href="{{ url_for('logout') }}" class="btn btn-primary">ë¡œê·¸ì•„ì›ƒ</a>
      {% else %}
        <a href="{{ url_for('login') }}" class="link">ë¡œê·¸ì¸</a>
        <a href="{{ url_for('signup') }}" class="btn btn-primary">íšŒì›ê°€ì…</a>
      {% endif %}
    </nav>
  </div>

  <main class="max-w-3xl mx-auto px-6 py-10">
    <!-- Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-4 space-y-2">
          {% for category, message in messages %}
            <div class="{{ 'text-red-600' if category=='error' else 'text-green-600' }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <article class="bg-white rounded-2xl border shadow-sm p-8">
      <header class="mb-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="px-2.5 py-1 rounded-full text-xs font-semibold
                         {{ 'bg-emerald-50 text-emerald-700 border border-emerald-200' if study.active else 'bg-gray-100 text-gray-500 border border-gray-200' }}">
              {{ 'ëª¨ì§‘ì¤‘' if study.active else 'ë§ˆê°' }}
            </span>
            <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-50 text-gray-700 border border-gray-200">
              {{ category_name }}
            </span>
          </div>
          <span class="text-sm text-gray-500">ğŸ‘¥ {{ applicants_count }}/{{ capacity }}</span>
        </div>
        <h1 class="mt-4 text-2xl font-extrabold text-gray-900">{{ study.title }}</h1>
      </header>

      <section class="space-y-2 text-sm text-gray-700">
        <div>ğŸ‘¤ ì£¼ìµœì: <strong>{{ study.host }}</strong></div>
        {% if study.start_at %}
          <div>ğŸ“… ì‹œì‘: {{ study.start_at.strftime("%Y-%m-%d %H:%M") }}</div>
        {% endif %}
        {% if study.duration_min %}
          <div>â± ì†Œìš”ì‹œê°„: {{ study.duration_min }}ë¶„</div>
        {% endif %}
      </section>

      <hr class="my-6" />

      <section class="prose max-w-none text-gray-800 whitespace-pre-wrap">
        {{ study.content or 'ìŠ¤í„°ë”” ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.' }}
      </section>

      <div class="mt-8 flex items-center gap-3">
        {% if user %}
          {% if is_host %}
            <button id="btn-close"
                    class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 disabled:opacity-60 disabled:cursor-not-allowed"
                    {% if not study.active %}disabled{% endif %}>
              ëª¨ì§‘ ì™„ë£Œ
            </button>
          {% else %}
            <button id="btn-apply"
                    class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed"
                    {% if already_applied or not study.active or is_full %}disabled{% endif %}>
              ì‹ ì²­í•˜ê¸°
            </button>
            {% if already_applied %}
              <span class="text-sm text-emerald-600">ì´ë¯¸ ì‹ ì²­í•˜ì…¨ìŠµë‹ˆë‹¤.</span>
            {% elif is_full %}
              <span class="text-sm text-red-600">ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.</span>
            {% elif not study.active %}
              <span class="text-sm text-gray-600">ì´ë¯¸ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
            {% endif %}
          {% endif %}
        {% else %}
          <a href="{{ url_for('login') }}" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">ë¡œê·¸ì¸ í›„ ì‹ ì²­</a>
        {% endif %}
      </div>
    </article>
  </main>

  <script>
    const studyId = "{{ study._id }}";

    async function call(url, opts={}) {
      const res = await fetch(url, {
        credentials: 'include',
        headers: {'Accept':'application/json','Content-Type':'application/json'},
        ...opts
      });
      let data = {};
      try { data = await res.json(); } catch(e) {}
      if (!res.ok || data.isSuccess === false) {
        throw new Error(data.message || 'ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
      return data;
    }

    const btnApply = document.getElementById('btn-apply');
    if (btnApply) {
      btnApply.addEventListener('click', async () => {
        try {
          btnApply.disabled = true;
          await call(`/api/studies/${studyId}/apply`, { method: 'POST' });
          alert('ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.reload();
        } catch (e) {
          alert(e.message || 'ì‹ ì²­ ì¤‘ ì˜¤ë¥˜');
          btnApply.disabled = false;
        }
      });
    }

    const btnClose = document.getElementById('btn-close');
    if (btnClose) {
      btnClose.addEventListener('click', async () => {
        if (!confirm('ëª¨ì§‘ì„ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
          btnClose.disabled = true;
          await call(`/api/studies/${studyId}/close`, { method: 'POST' });
          alert('ëª¨ì§‘ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.reload();
        } catch (e) {
          alert(e.message || 'ë§ˆê° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜');
          btnClose.disabled = false;
        }
      });
    }
  </script>
</body>
</html>
